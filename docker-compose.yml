volumes:
    langgraph-data:
        driver: local
    milvus-data:
        driver: local
    postgres-data:
        driver: local
services:
    langgraph-redis:
        image: redis:6
        healthcheck:
            test: redis-cli ping
            interval: 5s
            timeout: 1s
            retries: 5
        ports:
            - "6379:6379"
    
    milvus-etcd:
        image: quay.io/coreos/etcd:v3.5.5
        environment:
            ETCD_AUTO_COMPACTION_MODE: revision
            ETCD_AUTO_COMPACTION_RETENTION: "1000"
            ETCD_QUOTA_BACKEND_BYTES: "4294967296"
            ETCD_SNAPSHOT_COUNT: "50000"
        volumes:
            - milvus-data:/etcd
        command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
        healthcheck:
            test: ["CMD", "etcdctl", "endpoint", "health"]
            interval: 30s
            timeout: 20s
            retries: 3
    
    milvus-minio:
        image: minio/minio:RELEASE.2023-03-20T20-16-18Z
        environment:
            MINIO_ACCESS_KEY: minioadmin
            MINIO_SECRET_KEY: minioadmin
        ports:
            - "9001:9001"
            - "9000:9000"
        volumes:
            - milvus-data:/minio_data
        command: minio server /minio_data --console-address ":9001"
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
            interval: 30s
            timeout: 20s
            retries: 3
    
    milvus-standalone:
        image: milvusdb/milvus:v2.4.1
        container_name: milvus-standalone
        security_opt:
            - seccomp:unconfined
        environment:
            ETCD_ENDPOINTS: milvus-etcd:2379
            MINIO_ADDRESS: milvus-minio:9000
        volumes:
            - milvus-data:/var/lib/milvus
        command: milvus run standalone
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
            interval: 30s
            start_period: 90s
            timeout: 20s
            retries: 3
        ports:
            - "19530:19530"
            - "9091:9091"
        depends_on:
            milvus-etcd:
                condition: service_healthy
            milvus-minio:
                condition: service_healthy
        restart: unless-stopped
    
    postgres-db:
        image: postgres:16
        container_name: postgres-db
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: mydb
        ports:
            - "5432:5432"
        volumes:
            - postgres-data:/var/lib/postgresql/data
            - ./schema.sql:/docker-entrypoint-initdb.d/schema.sql
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 5s
            timeout: 1s
            retries: 5
            start_period: 10s
        restart: unless-stopped
    
    langgraph-api:
        image: "manager-chat"
        pull_policy: never
        ports:
            - "8123:8000"
        depends_on:
            langgraph-redis:
                condition: service_healthy
            milvus-standalone:
                condition: service_healthy
            postgres-db:
                condition: service_healthy
        env_file:
            - .env
        environment:
            REDIS_URI: redis://langgraph-redis:6379
            POSTGRES_URI: postgres://postgres:postgres@postgres-db:5432/mydb
            POSTGRES_HOST: postgres-db
            POSTGRES_PORT: "5432"
            MILVUS_HOST: milvus-standalone
            MILVUS_PORT: "19530"
        restart: unless-stopped
    
    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile
        ports:
            - "3000:3000"
        env_file:
            - ./frontend/.env
        environment:
            NODE_ENV: production
